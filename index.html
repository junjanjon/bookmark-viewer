<html>
<head>
    <meta charset="utf-8">
    <title>pixiv ブックマーク タグクラウド</title>
    <!-- Styles -->
    <style>
        #chartdiv {
            width: 100%;
            height: 600px;
        }
    </style>
</head>
<body>
    <!-- HTML -->
    <div id="chartdiv"></div>

    <!-- Resources -->
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/plugins/wordCloud.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>

    <!-- Chart code -->
    <script>
        // データからタグをカウントする
        function countTags(data) {
            var tags = {};
            for (var i = 0; i < data.length; i++) {
                var illustTags = data[i].tags;
                for (var j = 0; j < illustTags.length; j++) {
                    if (illustTags[j].name in tags) {
                        tags[illustTags[j].name]++;
                    } else {
                        tags[illustTags[j].name] = 1;
                    }
                }
            }
            return tags;
        }

        var launch = function(json) {
            var tags = countTags(json);
            console.log(tags);

            var data = Object.keys(tags).map(function(key) {
                return {
                    "tag": key,
                    "count": tags[key]
                }
            }).filter(function(item) {
                return 10 < item.count;
                 // return true;
            });

            return function() {
                // Themes begin
                am4core.useTheme(am4themes_animated);
                // Themes end

                const chart = am4core.create("chartdiv", am4plugins_wordCloud.WordCloud);
                const series = chart.series.push(new am4plugins_wordCloud.WordCloudSeries());
                series.randomness = 0.1;
                series.rotationThreshold = 0;

                series.data = data;
                series.dataFields.word = "tag";
                series.dataFields.value = "count";

                series.heatRules.push({
                    "target": series.labels.template,
                    "property": "fill",
                    "min": am4core.color("#0000CC"),
                    "max": am4core.color("#CC00CC"),
                    "dataField": "value"
                });

                series.labels.template.url = "https://www.pixiv.net/tags/{word}/artworks";
                series.labels.template.urlTarget = "_blank";
                series.labels.template.tooltipText = "{word}: {value}";

                const hoverState = series.labels.template.states.create("hover");
                hoverState.properties.fill = am4core.color("#FF0000");

                const subtitle = chart.titles.create();
                subtitle.text = "(click to open)";

                const title = chart.titles.create();
                title.text = "pixiv ブックマークタグ";
                title.fontSize = 20;
                title.fontWeight = "800";
            }
        };
        var myRequest = new Request('illust-bookmarks.json');
        fetch(myRequest).then(function(response) {
            return response.blob();
        }).then(function(response) {
            console.log(response);
            return response.text();
        }).then(function(text) {
            var json = JSON.parse(text);
            console.log(json);
            am4core.ready(launch(json));
        });
    </script>
</body>
</html>